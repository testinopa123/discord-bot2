{% extends "base.html" %}

{% block title %}Admin Panel - Discord Bot{% endblock %}

{% block content %}
<div class="space-y-8 fade-in" x-data="adminApp()">
    <!-- Header -->
    <div class="glass-card">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
                <p class="text-gray-300">Manage bot servers and administrative settings</p>
            </div>
            <div class="flex items-center space-x-2">
                <i class="fas fa-shield-alt text-discord-warning"></i>
                <span class="text-discord-warning font-semibold">Admin Access</span>
            </div>
        </div>
    </div>

    <!-- Server Management -->
    <div class="glass-card">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-white flex items-center">
                <i class="fas fa-server text-discord-blurple mr-3"></i>
                Server Management
            </h2>
            <div class="flex items-center space-x-4">
                <button @click="refreshGuilds()" class="btn-glass" :disabled="loading">
                    <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': loading}"></i>
                    Refresh
                </button>
                <input 
                    type="text" 
                    placeholder="Search servers..." 
                    class="search-input w-64"
                    x-model="searchQuery"
                >
            </div>
        </div>

        <div x-show="loading" class="text-center py-12">
            <div class="loading mx-auto"></div>
            <p class="text-gray-400 mt-4">Loading server information...</p>
        </div>

        <div x-show="!loading && guilds.length > 0" class="overflow-hidden rounded-lg">
            <table class="admin-table w-full">
                <thead>
                    <tr>
                        <th class="text-left">Server</th>
                        <th class="text-center">Members</th>
                        <th class="text-left">Owner</th>
                        <th class="text-center">Created</th>
                        <th class="text-center">Server ID</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="guild in filteredGuilds" :key="guild.id">
                        <tr class="hover:bg-white/5 transition-colors">
                            <td>
                                <div class="flex items-center">
                                    <img 
                                        :src="guild.icon || 'https://cdn.discordapp.com/embed/avatars/0.png'" 
                                        :alt="guild.name"
                                        class="w-10 h-10 rounded-full mr-3"
                                    >
                                    <div>
                                        <div class="font-semibold text-white" x-text="guild.name"></div>
                                        <div class="text-sm text-gray-400" x-text="guild.id"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="inline-flex items-center px-2 py-1 rounded-full bg-discord-blurple/20 text-discord-blurple">
                                    <i class="fas fa-users mr-1"></i>
                                    <span x-text="guild.member_count.toLocaleString()"></span>
                                </span>
                            </td>
                            <td>
                                <span class="text-gray-300" x-text="guild.owner"></span>
                            </td>
                            <td class="text-center">
                                <span class="text-gray-400" x-text="formatDate(guild.created_at)"></span>
                            </td>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    <code class="bg-black/20 px-2 py-1 rounded text-xs mr-2" x-text="guild.id"></code>
                                    <button 
                                        @click="copyToClipboard(guild.id)"
                                        class="copy-btn"
                                        title="Copy Server ID"
                                    >
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <button 
                                        @click="openServerInfo(guild)"
                                        class="btn-glass text-xs px-2 py-1"
                                        title="View Details"
                                    >
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <a 
                                        :href="`https://discord.com/channels/${guild.id}`"
                                        target="_blank"
                                        class="btn-glass text-xs px-2 py-1"
                                        title="Open in Discord"
                                    >
                                        <i class="fab fa-discord"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="!loading && guilds.length === 0" class="text-center py-12">
            <i class="fas fa-server text-4xl text-gray-500 mb-4"></i>
            <p class="text-gray-400">No servers found.</p>
        </div>

        <div x-show="!loading && filteredGuilds.length === 0 && guilds.length > 0" class="text-center py-12">
            <i class="fas fa-search text-4xl text-gray-500 mb-4"></i>
            <p class="text-gray-400">No servers match your search criteria.</p>
        </div>
    </div>

    <!-- Command Logs -->
    <div class="glass-card">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-white flex items-center">
                <i class="fas fa-history text-discord-success mr-3"></i>
                Command Logs
            </h2>
            <button @click="refreshLogs()" class="btn-glass" :disabled="logsLoading">
                <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': logsLoading}"></i>
                Refresh
            </button>
        </div>

        <div x-show="logsLoading" class="text-center py-8">
            <div class="loading mx-auto"></div>
            <p class="text-gray-400 mt-4">Loading command logs...</p>
        </div>

        <div x-show="!logsLoading && commandLogs.length > 0" class="overflow-hidden rounded-lg">
            <table class="admin-table w-full">
                <thead>
                    <tr>
                        <th class="text-left">Time</th>
                        <th class="text-left">Command</th>
                        <th class="text-left">User</th>
                        <th class="text-left">Server</th>
                        <th class="text-left">Channel</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="log in commandLogs.slice(0, 50)" :key="log.timestamp">
                        <tr class="hover:bg-white/5 transition-colors">
                            <td>
                                <span class="text-sm text-gray-400" x-text="formatTime(log.timestamp)"></span>
                            </td>
                            <td>
                                <code class="bg-discord-blurple/20 text-discord-blurple px-2 py-1 rounded text-sm" x-text="log.command"></code>
                            </td>
                            <td>
                                <div>
                                    <div class="text-white text-sm" x-text="log.username"></div>
                                    <div class="text-xs text-gray-400" x-text="log.user_id"></div>
                                </div>
                            </td>
                            <td>
                                <span class="text-gray-300 text-sm" x-text="log.guild"></span>
                            </td>
                            <td>
                                <span class="text-gray-300 text-sm" x-text="log.channel"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="!logsLoading && commandLogs.length === 0" class="text-center py-8">
            <i class="fas fa-history text-4xl text-gray-500 mb-4"></i>
            <p class="text-gray-400">No command logs available yet.</p>
        </div>
    </div>

    <!-- Command Runner -->
    <div class="glass-card">
        <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
            <i class="fas fa-play-circle text-discord-warning mr-3"></i>
            Run Command
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Select Server</label>
                <select x-model="selectedServer" @change="updateChannels()" class="search-input">
                    <option value="">Choose a server...</option>
                    <template x-for="server in servers" :key="server.id">
                        <option :value="server.id" x-text="server.name"></option>
                    </template>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Select Channel</label>
                <select x-model="selectedChannel" class="search-input" :disabled="!selectedServer">
                    <option value="">Choose a channel...</option>
                    <template x-for="channel in availableChannels" :key="channel.id">
                        <option :value="channel.id" x-text="`#${channel.name} (${channel.category})`"></option>
                    </template>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Command</label>
                <input 
                    type="text" 
                    x-model="commandToRun" 
                    placeholder="Enter command (e.g., help, status)"
                    class="search-input"
                >
            </div>
        </div>
        
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-400">
                <p>Commands will be executed as: <code class="bg-black/20 px-1 rounded" x-text="'*' + commandToRun"></code></p>
            </div>
            <button 
                @click="executeCommand()" 
                class="btn-discord"
                :disabled="!selectedServer || !selectedChannel || !commandToRun || commandExecuting"
            >
                <i class="fas fa-paper-plane mr-2" :class="{'animate-pulse': commandExecuting}"></i>
                <span x-text="commandExecuting ? 'Executing...' : 'Run Command'"></span>
            </button>
        </div>
        
        <div x-show="commandResult" class="mt-4 p-3 rounded-lg" :class="commandResult?.success ? 'bg-discord-success/20 border border-discord-success text-discord-success' : 'bg-discord-error/20 border border-discord-error text-discord-error'">
            <p x-text="commandResult?.message"></p>
        </div>
    </div>

    <!-- Admin User Management -->
    <div class="glass-card">
        <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
            <i class="fas fa-user-shield text-discord-error mr-3"></i>
            Admin User Management
        </h2>
        
        <!-- Add New Admin -->
        <div class="bg-white/5 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-white mb-4">Add New Admin</h3>
            <div class="flex gap-4">
                <input 
                    type="text" 
                    x-model="newAdminId" 
                    placeholder="Enter Discord User ID..."
                    class="search-input flex-1"
                >
                <button 
                    @click="addAdmin()" 
                    class="btn-discord"
                    :disabled="!newAdminId || adminManaging"
                >
                    <i class="fas fa-plus mr-2" :class="{'animate-pulse': adminManaging}"></i>
                    Add Admin
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">Note: This adds admin access for the current session only. For permanent access, add the user ID to the ADMIN_USER_IDS environment variable.</p>
        </div>
        
        <!-- Current Admins -->
        <div>
            <h3 class="text-lg font-semibold text-white mb-4">Current Admins</h3>
            <div x-show="adminLoading" class="text-center py-4">
                <div class="loading mx-auto"></div>
                <p class="text-gray-400 mt-2">Loading admin users...</p>
            </div>
            
            <div x-show="!adminLoading && admins.length > 0" class="space-y-2">
                <template x-for="admin in admins" :key="admin.id">
                    <div class="flex items-center justify-between bg-white/5 rounded-lg p-3">
                        <div>
                            <div class="text-white font-semibold" x-text="admin.username"></div>
                            <div class="text-sm text-gray-400" x-text="admin.id"></div>
                        </div>
                        <button 
                            @click="removeAdmin(admin.id)" 
                            class="btn-glass text-discord-error hover:bg-discord-error/20"
                            title="Remove Admin"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </template>
            </div>
            
            <div x-show="!adminLoading && admins.length === 0" class="text-center py-8">
                <i class="fas fa-user-shield text-4xl text-gray-500 mb-4"></i>
                <p class="text-gray-400">No admin users found.</p>
            </div>
        </div>
    </div>

    <!-- Server Statistics -->
    <div class="glass-card">
        <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
            <i class="fas fa-chart-bar text-discord-blurple mr-3"></i>
            Server Statistics
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="stat-card">
                <div class="stat-value" x-text="guilds.length"></div>
                <div class="stat-label">Total Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="totalMembers.toLocaleString()"></div>
                <div class="stat-label">Total Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="Math.round(averageMembers)"></div>
                <div class="stat-label">Avg Members/Server</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="largestServer?.member_count?.toLocaleString() || 0"></div>
                <div class="stat-label">Largest Server</div>
            </div>
        </div>
    </div>

    <!-- Copy Success Toast -->
    <div 
        x-show="showCopyToast" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed bottom-4 right-4 bg-discord-success text-white px-4 py-2 rounded-lg shadow-lg z-50"
    >
        <div class="flex items-center">
            <i class="fas fa-check mr-2"></i>
            <span>Server ID copied to clipboard!</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function adminApp() {
    return {
        guilds: [],
        loading: true,
        searchQuery: '',
        showCopyToast: false,
        
        // Command logs
        commandLogs: [],
        logsLoading: false,
        
        // Command runner
        servers: [],
        selectedServer: '',
        selectedChannel: '',
        commandToRun: '',
        commandExecuting: false,
        commandResult: null,
        
        // Admin management
        admins: [],
        adminLoading: false,
        adminManaging: false,
        newAdminId: '',
        
        get filteredGuilds() {
            if (!this.searchQuery) return this.guilds;
            const query = this.searchQuery.toLowerCase();
            return this.guilds.filter(guild => 
                guild.name.toLowerCase().includes(query) ||
                guild.id.includes(query) ||
                guild.owner.toLowerCase().includes(query)
            );
        },
        
        get totalMembers() {
            return this.guilds.reduce((total, guild) => total + guild.member_count, 0);
        },
        
        get averageMembers() {
            return this.guilds.length > 0 ? this.totalMembers / this.guilds.length : 0;
        },
        
        get largestServer() {
            return this.guilds.reduce((largest, guild) => 
                guild.member_count > (largest?.member_count || 0) ? guild : largest, null
            );
        },
        
        get availableChannels() {
            const server = this.servers.find(s => s.id === this.selectedServer);
            return server ? server.channels : [];
        },
        
        async init() {
            await Promise.all([
                this.refreshGuilds(),
                this.refreshLogs(),
                this.loadServersAndChannels(),
                this.loadAdmins()
            ]);
        },
        
        async refreshGuilds() {
            this.loading = true;
            try {
                const response = await fetch('/api/guilds');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.guilds = data.guilds.sort((a, b) => b.member_count - a.member_count);
                } else {
                    console.error('Failed to load guilds:', data.message);
                }
            } catch (error) {
                console.error('Error fetching guilds:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async refreshLogs() {
            this.logsLoading = true;
            try {
                const response = await fetch('/api/command-logs');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.commandLogs = data.logs;
                } else {
                    console.error('Failed to load command logs:', data.message);
                }
            } catch (error) {
                console.error('Error fetching command logs:', error);
            } finally {
                this.logsLoading = false;
            }
        },
        
        async loadServersAndChannels() {
            try {
                const response = await fetch('/api/servers-channels');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.servers = data.servers;
                } else {
                    console.error('Failed to load servers and channels:', data.message);
                }
            } catch (error) {
                console.error('Error fetching servers and channels:', error);
            }
        },
        
        async loadAdmins() {
            this.adminLoading = true;
            try {
                const response = await fetch('/api/admin-users');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.admins = data.admins;
                } else {
                    console.error('Failed to load admins:', data.message);
                }
            } catch (error) {
                console.error('Error fetching admins:', error);
            } finally {
                this.adminLoading = false;
            }
        },
        
        updateChannels() {
            this.selectedChannel = '';
            this.commandResult = null;
        },
        
        async executeCommand() {
            if (!this.selectedServer || !this.selectedChannel || !this.commandToRun) return;
            
            this.commandExecuting = true;
            this.commandResult = null;
            
            try {
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        channel_id: this.selectedChannel,
                        command: this.commandToRun
                    })
                });
                
                const data = await response.json();
                this.commandResult = {
                    success: data.status === 'success',
                    message: data.message
                };
                
                // Refresh logs to show the new command
                if (data.status === 'success') {
                    setTimeout(() => this.refreshLogs(), 1000);
                }
                
            } catch (error) {
                this.commandResult = {
                    success: false,
                    message: 'Failed to execute command: ' + error.message
                };
            } finally {
                this.commandExecuting = false;
            }
        },
        
        async addAdmin() {
            if (!this.newAdminId) return;
            
            this.adminManaging = true;
            try {
                const response = await fetch('/api/admin-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: this.newAdminId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    this.newAdminId = '';
                    await this.loadAdmins();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to add admin: ' + error.message);
            } finally {
                this.adminManaging = false;
            }
        },
        
        async removeAdmin(userId) {
            if (!confirm('Are you sure you want to remove this admin user?')) return;
            
            try {
                const response = await fetch('/api/admin-users', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    await this.loadAdmins();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to remove admin: ' + error.message);
            }
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        },
        
        formatTime(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                this.showCopyToast = true;
                setTimeout(() => {
                    this.showCopyToast = false;
                }, 3000);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
            }
        },
        
        openServerInfo(guild) {
            alert(`Server: ${guild.name}\nID: ${guild.id}\nMembers: ${guild.member_count}\nOwner: ${guild.owner}\nCreated: ${this.formatDate(guild.created_at)}`);
        }
    }
}
</script>
{% endblock %}